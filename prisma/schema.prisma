generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Account {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  User              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model BitcoinDeposit {
  id            String    @id
  userId        String
  address       String
  amountBtc     Decimal?
  amountUsd     Decimal?
  status        String    @default("pending")
  txHash        String?
  confirmations Int       @default(0)
  confirmedAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  metadata      Json?     @default("{}")
  User          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([address])
  @@index([status])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model CourseProgress {
  id        String   @id
  userId    String
  courseId  String
  lessonId  String
  completed Boolean  @default(false)
  progress  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId, lessonId])
  @@index([courseId])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model CryptoWatchlist {
  id          String   @id
  userId      String
  symbol      String
  displayName String
  addedAt     DateTime @default(now())
  User        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, symbol])
  @@index([userId])
}

/// This model or at least one of its fields has comments in the database, and requires an additional setup for migrations: Read more: https://pris.ly/d/database-comments
/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Deposit {
  id              String    @id
  portfolioId     String
  amount          Decimal
  currency        String
  status          String    @default("PENDING")
  createdAt       DateTime  @default(now())
  updatedAt       DateTime
  metadata        Json?     @default("{}")
  transactionId   String?
  type            String?
  userId          String?
  method          String?
  paymentId       String?   @unique
  paymentAddress  String?
  paymentAmount   Decimal?
  paymentStatus   String?
  cryptoAmount    Decimal?
  cryptoCurrency  String?
  invoiceUrl      String?
  confirmations   Int       @default(0)
  fee             Decimal?
  targetAsset     String?
  transactionHash String?
  Portfolio       Portfolio @relation(fields: [portfolioId], references: [id])
  User            User?     @relation(fields: [userId], references: [id])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model FileStorage {
  id            String   @id
  userId        String
  fileId        String
  fileType      String
  fileName      String?
  fileSize      Int?
  mimeType      String?
  extractedText String?
  metadata      Json?    @default("{}")
  uploadedAt    DateTime @default(now())
  User          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model KycVerification {
  id                String    @id
  userId            String    @unique
  firstName         String
  lastName          String
  dateOfBirth       String
  nationality       String
  phoneNumber       String
  address           String
  city              String
  postalCode        String
  country           String
  idDocumentUrl     String
  proofOfAddressUrl String
  selfieUrl         String
  status            KycStatus @default(PENDING)
  submittedAt       DateTime  @default(now())
  reviewedAt        DateTime?
  reviewedBy        String?
  rejectionReason   String?
  updatedAt         DateTime
  User              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model ModerationRule {
  id            String   @id
  keyword       String
  action        String
  severity      String
  isActive      Boolean  @default(true)
  caseSensitive Boolean  @default(false)
  isRegex       Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model NewsArticle {
  id          String   @id
  title       String
  description String?
  url         String
  source      String
  category    String
  publishedAt DateTime
  sentiment   String?
  createdAt   DateTime @default(now())
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Notification {
  id        String           @id
  userId    String
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  amount    Decimal?
  asset     String?
  metadata  Json?            @default("{}")
  createdAt DateTime         @default(now())
  User      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, read])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model PaperPortfolio {
  id         String       @id
  userId     String       @unique
  balance    Decimal      @default(100000.00)
  assets     Json         @default("[]")
  createdAt  DateTime     @default(now())
  updatedAt  DateTime
  User       User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  PaperTrade PaperTrade[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model PaperTrade {
  id               String         @id
  userId           String
  paperPortfolioId String
  symbol           String
  side             TradeType
  entryPrice       Decimal
  exitPrice        Decimal?
  quantity         Decimal
  profit           Decimal        @default(0.00)
  commission       Decimal        @default(0.00)
  leverage         Int            @default(1)
  status           TradeStatus    @default(OPEN)
  openedAt         DateTime       @default(now())
  closedAt         DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime
  metadata         Json?          @default("{}")
  PaperPortfolio   PaperPortfolio @relation(fields: [paperPortfolioId], references: [id], onDelete: Cascade)
  User             User           @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([paperPortfolioId])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Portfolio {
  id               String       @id
  userId           String       @unique
  balance          Decimal      @default(0.00)
  balanceCurrency  String       @default("USD")
  traderoomBalance Decimal      @default(0.00)
  assets           Json         @default("[]")
  Deposit          Deposit[]
  User             User         @relation(fields: [userId], references: [id])
  Withdrawal       Withdrawal[]
}

/// Push notification subscriptions for Web Push API
model PushSubscription {
  id        String   @id
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model PriceAlert {
  id          String    @id
  userId      String
  symbol      String
  targetPrice Decimal
  condition   String
  isActive    Boolean   @default(true)
  triggered   Boolean   @default(false)
  triggeredAt DateTime?
  chatId      BigInt
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  User        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([symbol, isActive])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Quiz {
  id          String   @id
  title       String
  description String?
  questions   Json
  chatId      BigInt?
  messageId   BigInt?
  isActive    Boolean  @default(true)
  responses   Json     @default("[]")
  createdAt   DateTime @default(now())
  updatedAt   DateTime
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model ScheduledMessage {
  id            String    @id
  userId        String
  chatId        BigInt
  message       String
  scheduledFor  DateTime
  sent          Boolean   @default(false)
  sentAt        DateTime?
  recurring     Boolean   @default(false)
  recurringType String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  User          User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([scheduledFor, sent])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Session {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  User         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Strategy {
  id              String            @id
  userId          String
  title           String
  description     String
  category        String
  difficulty      String
  content         String
  isPremium       Boolean           @default(false)
  isPublished     Boolean           @default(true)
  viewCount       Int               @default(0)
  likeCount       Int               @default(0)
  commentCount    Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  User            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  StrategyComment StrategyComment[]
  StrategyLike    StrategyLike[]

  @@index([category])
  @@index([createdAt])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model StrategyComment {
  id         String   @id
  strategyId String
  userId     String
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime
  Strategy   Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([strategyId])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model StrategyLike {
  id         String   @id
  strategyId String
  userId     String
  createdAt  DateTime @default(now())
  Strategy   Strategy @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([strategyId, userId])
  @@index([strategyId])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model TelegramLinkCode {
  id        String   @id
  userId    String   @unique
  code      String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([code])
  @@index([expiresAt])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model TelegramUser {
  id                String    @id
  telegramId        BigInt    @unique
  username          String?
  firstName         String?
  lastName          String?
  languageCode      String    @default("en")
  isBot             Boolean   @default(false)
  isPremium         Boolean   @default(false)
  preferredLanguage String    @default("en")
  timezone          String?
  notifications     Boolean   @default(true)
  warningCount      Int       @default(0)
  isBanned          Boolean   @default(false)
  bannedAt          DateTime?
  bannedReason      String?
  messageCount      Int       @default(0)
  lastMessageAt     DateTime?
  joinedAt          DateTime  @default(now())
  createdAt         DateTime  @default(now())
  updatedAt         DateTime
  linkCode          String?
  linkCodeExpiresAt DateTime?

  @@index([linkCode])
  @@index([telegramId])
  @@index([username])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Trade {
  id         String      @id
  userId     String
  symbol     String
  side       TradeType
  entryPrice Decimal
  exitPrice  Decimal?
  quantity   Decimal
  profit     Decimal     @default(0.00)
  commission Decimal     @default(0.00)
  leverage   Int         @default(1)
  status     TradeStatus @default(OPEN)
  openedAt   DateTime    @default(now())
  closedAt   DateTime?
  createdAt  DateTime    @default(now())
  updatedAt  DateTime
  metadata   Json?       @default("{}")
  User       User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model TradingSignal {
  id          String    @id
  symbol      String
  action      String
  price       Decimal
  targetPrice Decimal?
  stopLoss    Decimal?
  confidence  Decimal
  analysis    String
  indicators  Json      @default("{}")
  isActive    Boolean   @default(true)
  expiresAt   DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model User {
  id                     String             @id
  name                   String?
  email                  String?            @unique
  emailVerified          DateTime?
  image                  String?
  password               String?
  role                   UserRole           @default(USER)
  accountType            AccountType        @default(INVESTOR)
  country                String?
  preferredCurrency      String             @default("USD")
  isEmailVerified        Boolean            @default(false)
  isDeleted              Boolean            @default(false)
  emailNotifications     Boolean            @default(true)
  tradingNotifications   Boolean            @default(true)
  securityNotifications  Boolean            @default(true)
  kycNotifications       Boolean            @default(true)
  tutorialCompleted      Boolean            @default(false)
  isVerified             Boolean            @default(false)
  verifiedAt             DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime
  isOriginAdmin          Boolean            @default(false)
  assignedStaffId        String?
  linkedTelegramId       BigInt?            @unique
  linkedTelegramUsername String?
  twoFactorEnabled       Boolean            @default(false)
  twoFactorMethod        TwoFactorMethod?
  twoFactorSecret        String?
  transferPin            String?
  accountNumber          String?            @unique
  Account                Account[]
  BitcoinDeposit         BitcoinDeposit[]
  CourseProgress         CourseProgress[]
  CryptoWatchlist        CryptoWatchlist[]
  Deposit                Deposit[]
  FileStorage            FileStorage[]
  KycVerification        KycVerification?
  Notification           Notification[]
  PaperPortfolio         PaperPortfolio?
  PaperTrade             PaperTrade[]
  Portfolio              Portfolio?
  PriceAlert             PriceAlert[]
  ScheduledMessage       ScheduledMessage[]
  Session                Session[]
  Strategy               Strategy[]
  StrategyComment        StrategyComment[]
  StrategyLike           StrategyLike[]
  TelegramLinkCode       TelegramLinkCode?
  Trade                  Trade[]
  UserActivity           UserActivity[]
  UserStatistics         UserStatistics[]
  Withdrawal             Withdrawal[]
  SentTransfers          P2PTransfer[]      @relation("SentTransfers")
  ReceivedTransfers      P2PTransfer[]      @relation("ReceivedTransfers")
  PushSubscription       PushSubscription[]
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model UserActivity {
  id           String       @id
  userId       String?
  sessionId    String?
  activityType ActivityType
  page         String?
  action       String?
  metadata     Json?        @default("{}")
  ipAddress    String?
  userAgent    String?
  createdAt    DateTime     @default(now())
  User         User?        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([activityType, createdAt])
  @@index([sessionId])
  @@index([userId, createdAt])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model UserStatistics {
  id                 String   @id
  userId             String
  date               DateTime @default(now())
  messagesCount      Int      @default(0)
  imagesGenerated    Int      @default(0)
  cryptoQueriesCount Int      @default(0)
  commandsUsed       Json     @default("{}")
  User               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
  @@index([userId])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model Withdrawal {
  id            String    @id
  portfolioId   String
  amount        Decimal
  currency      String
  status        String    @default("PENDING")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime
  metadata      Json?     @default("{}")
  transactionId String?
  type          String?
  userId        String?
  method        String?
  fee           Decimal?
  Portfolio     Portfolio @relation(fields: [portfolioId], references: [id])
  User          User?     @relation(fields: [userId], references: [id])
}

enum AccountType {
  INVESTOR
  TRADER
}

enum ActivityType {
  PAGE_VIEW
  BUTTON_CLICK
  API_CALL
  TELEGRAM_COMMAND
  TELEGRAM_MESSAGE
  LOGIN
  LOGOUT
  SIGNUP
  DEPOSIT
  WITHDRAWAL
  TRADE
  KYC_SUBMISSION
  SETTINGS_UPDATE
  ERROR
}

/// This model contains row level security and requires additional setup for migrations. Visit https://pris.ly/d/row-level-security for more info.
model P2PTransfer {
  id                     String    @id
  senderId               String
  receiverId             String
  amount                 Decimal
  currency               String    @default("USD")
  status                 String    @default("PENDING")
  description            String?
  senderAccountNumber    String
  receiverAccountNumber  String
  receiverEmail          String
  receiverName           String
  transactionReference   String    @unique
  failureReason          String?
  processedAt            DateTime?
  createdAt              DateTime  @default(now())
  updatedAt              DateTime
  Sender                 User      @relation("SentTransfers", fields: [senderId], references: [id], onDelete: Cascade)
  Receiver               User      @relation("ReceivedTransfers", fields: [receiverId], references: [id], onDelete: Cascade)

  @@index([senderId])
  @@index([receiverId])
  @@index([status])
  @@index([createdAt])
  @@index([transactionReference])
}

enum KycStatus {
  PENDING
  APPROVED
  REJECTED
  UNDER_REVIEW
}

enum NotificationType {
  DEPOSIT
  WITHDRAW
  TRADE
  INFO
  WARNING
  SUCCESS
  TRANSACTION
}

enum TradeStatus {
  OPEN
  CLOSED
  CANCELLED
}

enum TradeType {
  BUY
  SELL
}

enum TwoFactorMethod {
  APP
  EMAIL
}

enum UserRole {
  USER
  ADMIN
  STAFF_ADMIN
}
